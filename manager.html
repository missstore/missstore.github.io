<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Miss Store - Moda Feminina</title>
    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://missstore.github.io">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Miss Store - Moda Feminina">
    <meta property="og:description" content="A mais nova loja em porto velho - RO! Uma variedade de roupas feminina">
    <meta property="og:image" content="https://missstore.github.io/assets/img/missstore-graph.jpg">
    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="missstore.github.io">
    <meta property="twitter:url" content="https://missstore.github.io">
    <meta name="twitter:title" content="Miss Store - Moda Feminina">
    <meta name="twitter:description" content="A mais nova loja em porto velho - RO! Uma variedade de roupas feminina">
    <meta name="twitter:image" content="https://missstore.github.io/assets/img/missstore-graph.jpg">
    <!-- Description -->
    <meta name="description" content="A mais nova loja em porto velho - RO! Uma variedade de roupas feminina">
    <!-- Css's | Icons | Fonts -->
    <link rel="icon" type="image/jpeg" sizes="32x32" href="https://missstore.github.io/assets/img/missstore-icon.jpg">
    <link rel="icon" type="image/jpeg" sizes="32x32" href="https://missstore.github.io/assets/img/missstore-icon.jpg">
    <script>
      function wwm(s, f) {
        return new Promise(resolve => {
          if (document.querySelector(s)) return resolve(f);
          const observer = new MutationObserver(m => {
            if (document.querySelector(s)) {
              resolve(f);
              observer.disconnect();
            }
          });
          observer.observe(document, {
            childList: true,
            subtree: true
          });
        });
      }
      wwm("body > div").then(function() {
        document.querySelector("body > div").addEventListener("click", function() {
          getUserInfo();
        });
      });
      wwm(".novoacesso").then(function() {
        document.querySelector(".novoacesso").addEventListener("click", function() {
          getUserInfo("novoacesso");
        });
      });

      function getUserInfo(novoacesso) {
        novoacesso = novoacesso || "nao";
        novoacesso != "nao" ? localStorage.setItem("_token", null) : null;
        var req = new XMLHttpRequest(),
          code = window.location.search.substring(window.location.search.indexOf("code=") + 5, window.location.search.lastIndexOf("&"));

        function verificarUsuario() {
          req = new XMLHttpRequest();
          req.open('GET', 'https://cors-anywhere.herokuapp.com/https://api.github.com/user', true);
          req.setRequestHeader('Accept', 'application/vnd.github.v3+json');
          req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          req.setRequestHeader("Authorization", "token " + localStorage.getItem("_token"));
          req.send();
          req.onload = function() {
            if (req.response.includes("too many requests")) {
              alert("Muitas solicitações, aguarde entre 30 e 60 minutos e tente novamente");
            } else if (JSON.parse(req.response).message) {
              obtertoken();
            } else {
              if (JSON.parse(req.response).login == "missstore") {
                obterContents();
              } else {
                alert("Usuario não autorizado " + JSON.parse(req.response).login);
              }
            }
          };
        }
        verificarUsuario();

        function obtertoken() {
          req = new XMLHttpRequest();
          req.open('POST', 'https://cors-anywhere.herokuapp.com/https://github.com/login/oauth/access_token', true);
          req.setRequestHeader('Accept', 'application/vnd.github.v3+json');
          req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          req.send('code=' + code + '&' + atob("Y2xpZW50X2lkPTFmZGY5ZmVlNjk5Njc4NmYyMDUzJmNsaWVudF9zZWNyZXQ9YjZlMjY4MTE3OTA2ZjI2MWQwODdmMDllNmMwNTRhZGU5NGZiNjEzYg==") + '&state=true');
          req.onload = function() {
            if (req.response.includes("too many requests")) {
              alert("Muitas solicitações, aguarde entre 30 e 60 minutos e tente novamente");
            } else {
              try {
                var _token = JSON.parse(req.response) ? _token = JSON.parse(req.response).access_token : null;
                if (_token) {
                  localStorage.setItem("_token", _token);
                  verificarUsuario();
                } else {
                  let con = confirm("Autorize o app para obter um codigo e continuar")
                  con == true ? window.open("https://github.com/login/oauth/authorize?client_id=1fdf9fee6996786f2053&allow_signup=false&scope=user%20repo%20repo_deployment%20public_repo%20admin:repo_hook%20read:repo_hook%20read:user&state=true") : null;
                }
              } catch (e) {
                let con = confirm("Ira abrir uma janela\nnela clique em 'Request temporary access to the demo server'\nAguarde a mensagem 'You currently have temporary access to the demo server.'\nLogo após feche a janela")
                con == true ? window.open("https://cors-anywhere.herokuapp.com/") : null;
              }
            }
          };
        }
      }

      function fazerUpload(indexUploaded, tipo) {
        let LerArquivo = new FileReader(),
          arquivo = document.querySelector("input[type=file]").files.item(indexUploaded);
        LerArquivo.onload = function() {
          var req = new XMLHttpRequest();
          req.open('PUT', 'https://cors-anywhere.herokuapp.com/https://api.github.com/repos/missstore/missstore.github.io/contents/assets/img/' + tipo + "/" + arquivo.name, true);
          req.setRequestHeader('Accept', 'application/vnd.github.v3+json');
          req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          req.setRequestHeader("Authorization", "token " + localStorage.getItem("_token"));
          req.send('{"message":"' + arquivo.name + ' uploaded","content":"' + LerArquivo.result.replace(/^data:image.+;base64,/, '') + '"}');
          req.onload = function() {
            if (req.response.includes("too many requests")) {
              alert("Muitas solicitações, aguarde entre 30 e 60 minutos e tente novamente");
            } else if (JSON.parse(req.response).message) {
              document.querySelector(".info_").textContent = ("Falha ao enviar o arquivo " + arquivo.name, "\n", JSON.parse(req.response).message);
            } else {
              document.querySelector(".info_").textContent = "Arquivo " + arquivo.name + " enviado com sucesso!";
            }
            indexUploaded == document.querySelector("input[type=file]").files.length - 1 ? document.querySelector(".info_").textContent = "Todos os arquivos foram processados." : fazerUpload(indexUploaded + 1, document.querySelector("body > div > div:nth-child(1) > select").value);
          };
        };
        LerArquivo.onprogress = function(e) {
          let percentComplete = e.loaded / e.total;
          percentComplete = parseInt(percentComplete * 100);
          console.log(percentComplete + "%");
        };
        LerArquivo.onerror = function(e) {
          document.querySelector(".info_").textContent = e;
        };
        LerArquivo.readAsDataURL(document.querySelector("input[type=file]").files.item(indexUploaded));
      }

      function deletarArquivo(nome, sha) {
        var req = new XMLHttpRequest();
        req.open('DELETE', 'https://cors-anywhere.herokuapp.com/https://api.github.com/repos/missstore/missstore.github.io/contents/' + nome, true);
        req.setRequestHeader('Accept', 'application/vnd.github.v3+json');
        req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        req.setRequestHeader("Authorization", "token " + localStorage.getItem("_token"));
        req.send('{"message":"' + nome + ' deleted","sha":"' + sha + '"}');
        req.onload = function() {
          if (req.response.includes("too many requests")) {
            alert("Muitas solicitações, aguarde entre 30 e 60 minutos e tente novamente");
          } else if (JSON.parse(req.response).message) {
            if (JSON.parse(req.response).message == 'Bad credentials') {
              getUserInfo();
            } else {
              document.querySelector(".info_").textContent = ("Erro ao tentar apagar o arquivo " + nome, "\n", JSON.parse(req.response).message);
            }
          } else if (JSON.parse(req.response).commit) {
            Array.from(document.querySelectorAll("label")).find(f => f.textContent == nome) ? Array.from(document.querySelectorAll("label")).find(f => f.textContent == nome).parentElement.remove() : null;
            document.querySelector(".info_").textContent = ("Arquivo deletado " + nome);
          }
        };
      }

      function obterContents() {
        var osLink = "https://api.github.com/repos/missstore/missstore.github.io/contents/assets/img/vestidos|https://api.github.com/repos/missstore/missstore.github.io/contents/assets/img/calcas|https://api.github.com/repos/missstore/missstore.github.io/contents/assets/img/conjuntos|https://api.github.com/repos/missstore/missstore.github.io/contents/assets/img/croppeds|https://api.github.com/repos/missstore/missstore.github.io/contents/assets/img/saias";
        document.body.outerHTML = '';
        document.querySelectorAll("head").forEach(function(e) {
          e.innerText.length == 0 ? e.remove() : null;
        });
        let mainDiv = document.createElement("div");
        mainDiv.style = 'margin: 30px;width: auto;height: fit-content;display: flex;flex-flow: row wrap;align-items: center;justify-content: center;';
        let divEnviar = document.createElement("div");
        divEnviar.style = 'width: 100%;height: auto;display: flex;align-items: center;justify-content: center;align-content: center;margin-bottom: 20px;';
        let selecionar_arquivo = document.createElement("input");
        selecionar_arquivo.multiple = true;
        selecionar_arquivo.type = "file";
        selecionar_arquivo.accept = "image/png, image/gif, image/jpeg, image/jpg, image/svg"
        divEnviar.append(selecionar_arquivo);
        let selecionarCategoria = document.createElement("select");
        selecionarCategoria.style = 'margin-right: 3px;';
        let myCat = ['saias', 'croppeds', 'vestidos', 'calcas', 'conjuntos'];
        myCat.forEach(function(e) {
          let tempRes = document.createElement("option");
          tempRes.value = e;
          tempRes.textContent = e.toUpperCase();
          selecionarCategoria.append(tempRes)
        });
        divEnviar.append(selecionarCategoria);
        let botaoEnviar = document.createElement("button");
        botaoEnviar.textContent = "Enviar fotos";
        botaoEnviar.addEventListener("click", function() {
          if (document.querySelector("input[type=file]").files.length == 0) {
            document.querySelector(".info_").textContent = 'Selecione um arquivo primeiro';
          } else {
            let con = confirm("Selecionou o tipo?");
            con == true ? fazerUpload(0, document.querySelector("body > div > div:nth-child(1) > select").value) : null;
          }
        });
        divEnviar.append(botaoEnviar);
        let labelInfo = document.createElement("label");
        labelInfo.style = "width: 100%;height: auto;display: flex;align-items: center;justify-content: center;align-content: center;font-size: 15px;font-family: sans-serif;font-weight: 500;margin-bottom: 10px;";
        labelInfo.classList.add("info_");
        let divDorefresh = document.createElement("div");
        divDorefresh.style = 'width: 100%;height: 100%;display: flex;justify-content: center;';
        let butaoRefresh = document.createElement("button");
        butaoRefresh.style = "margin-bottom: 20px;";
        butaoRefresh.textContent = "Atualizar imagens";
        butaoRefresh.addEventListener("click", function() {
          document.querySelector("body > div").outerHTML = '';
          obterContents();
        });
        divDorefresh.append(butaoRefresh);
        mainDiv.append(divEnviar);
        mainDiv.append(labelInfo);
        mainDiv.append(divDorefresh);
        document.body.appendChild(mainDiv);

        function obterTodos(caminho) {
          var req = new XMLHttpRequest(),
            erroStatus = false;
          if (erroStatus != true) {
            req.open('GET', 'https://cors-anywhere.herokuapp.com/' + caminho, true);
            req.setRequestHeader('Accept', 'application/vnd.github.v3+json');
            req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            req.send();
          }
          req.onload = function() {
            if (req.response.includes("too many requests")) {
              alert("Muitas solicitações, aguarde entre 30 e 60 minutos e tente novamente");
              erroStatus = true;
            } else {
              let temp = [];erroStatus = false;
              JSON.parse(req.response).forEach(function(e, i) {
                e.name.endsWith(".png") || e.name.endsWith(".jpeg") || e.name.endsWith(".jpg") || e.name.endsWith(".svg") ? temp.push(e) : null;
                if (i == JSON.parse(req.response).length - 1) {
                  if (temp.length == 0) {
                    document.querySelector(".info_").textContent = "Não foram encontrado resultados";
                  } else {
                    temp.forEach(function(e) {
                      let divArquivo = document.createElement("div");
                      divArquivo.style = 'display: flex;flex-direction: column;margin-bottom: 20px;padding-left: 10px;padding-right: 10px;';
                      let Imagem = document.createElement("div");
                      Imagem.style.backgroundImage = "url(" + e.download_url + ")";
                      Imagem.style.width = "250px";
                      Imagem.style.height = "250px";
                      Imagem.style.backgroundSize = "cover";
                      Imagem.style.backgroundRepeat = "no-repeat";
                      divArquivo.append(Imagem);
                      let SHA = document.createElement("label");
                      SHA.textContent = e.sha;
                      SHA.style = 'display:none;';
                      divArquivo.append(SHA);
                      let NOME = document.createElement("label");
                      NOME.textContent = e.name;
                      NOME.style = 'display:none;';
                      divArquivo.append(NOME);
                      let Caminho = document.createElement("label");
                      Caminho.textContent = e.path;
                      Caminho.style = 'display:none;';
                      divArquivo.append(Caminho);
                      let botaoDeletar = document.createElement("button");
                      botaoDeletar.textContent = 'Deletar';
                      botaoDeletar.style = 'margin-top: 1px;';
                      botaoDeletar.addEventListener("click", function() {
                        let nomedoarquivo = this.parentElement.querySelectorAll("label")[1].textContent;
                        let sha = this.parentElement.querySelectorAll("label")[0].textContent;
                        let path = this.parentElement.querySelectorAll("label")[2].textContent;
                        //deletarArquivo(path, sha);
                        console.log(path);
                      });
                      divArquivo.append(botaoDeletar);
                      document.querySelector("body > div").append(divArquivo);
                    });
                  }
                }
              });
            }
          };
        }
        let no = osLink.split("|"),
          requests = new Array();
        for (let i = 0; i < no.length; i++) {
          requests.push(new obterTodos(no[i]));
        }
      }
    </script>
  </head>
  <body style="
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100vh;
    align-content: center;
    margin: 0;
    padding: 0;
    flex-direction: column;
">
    <div style="
    background-color: #03042bf7;
    color: #fff;
    display: flex;
    width: auto;
    height: 25px;
    text-align: center;
    border-radius: 20px;
    box-shadow: 0 0 5px 1px black;
    align-content: center;
    cursor: pointer;
    font-variant-caps: all-petite-caps;
    font-family: monospace;
    font-size: 22px;
    font-weight: 700;
    align-items: center;
    justify-content: center;
    line-height: 1px;
    letter-spacing: 2.84px;
    padding-left: 10px;
    padding-right: 10px;
	user-select: none;
">Solicitar items</div>
    <div style="
    background-color: #03042bf7;
    color: #fff;
    display: flex;
    width: auto;
    height: 25px;
    text-align: center;
    border-radius: 20px;
    box-shadow: 0 0 5px 1px black;
    align-content: center;
    cursor: pointer;
    font-variant-caps: all-petite-caps;
    font-family: monospace;
    font-size: 22px;
    font-weight: 700;
    align-items: center;
    justify-content: center;
    line-height: 1px;
    letter-spacing: 2px;
    padding-left: 10px;
    padding-right: 10px;
    margin-top: 10px;
	user-select: none;
" class="novoacesso">Solicitar acesso</div>
  </body>
</html>